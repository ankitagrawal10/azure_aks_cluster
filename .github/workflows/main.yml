name: Create AKS Cluster with Terraform

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  AKS-Cluster-Deployment:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: .

    steps:
      - name: Checkout
        uses: actions/checkout@v3.1.0

      - name: 'Az CLI login'
        run: |
          az login --tenant add67cd2-c8b2-416c-b171-b61b22be92f4

      - name: Update Azure CLI to the Latest Version
        run: |
          sudo apt-get update && sudo apt-get install --only-upgrade -y azure-cli

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2.0.2
        with:
          terraform_version: latest

      - name: Terraform Init
        id: init
        run: terraform init

      - name: Terraform Validate
        id: validate
        run: terraform validate

      - name: Refresh Terraform State
        id: refresh
        run: terraform refresh

      - name: Terraform Plan
        id: plan
        run: terraform plan

      - name: Terraform Apply
        id: apply
        run: terraform apply -auto-approve

      - name: Debug Terraform Outputs
        run: |
         echo "=== Terraform Outputs ==="
         terraform output
         echo "=== JSON Format ==="
         terraform output -json aks_cluster_name

      # - name: Get AKS Cluster Name
      #   id: get_aks_name
      #   run: |
      #       AKS_CLUSTER_NAME=$(terraform output aks_cluster_name | tr -d '"')
    
      #       # Debug output
      #       echo "Extracted AKS_CLUSTER_NAME: $AKS_CLUSTER_NAME"

      # Fetch and Export Resource Group Name

     

      - name: Get AKS Credentials
        run: |
          az aks get-credentials --name "ankit-cluster" --resource-group "ankit-rg"


      - name: Build AKS Cluster and Push Image
        run: |
          docker build -t notes-app ./django-notes-app/
          docker tag notes-app:latest projectimage01.azurecr.io/notes-app:latest
          az acr login --name projectimage01
          docker push projectimage01.azurecr.io/notes-app:latest

      # Fetch and Export ACR Credentials (Username and Password)
      - name: Fetch ACR Credentials
        id: fetch_credentials
        run: |
          ACR_USERNAME=$(terraform output username | tr -d '"')
          ACR_PASSWORD=$(terraform output password | tr -d '"')
          echo "Extracted ACR_USERNAME: $ACR_USERNAME" 
          echo "Extracted ACR_PASSWORD: $ACR_PASSWORD"  

      - name: Docker Azure login
      - uses: azure/docker-login@v1
        with: 
          login-server: projectimage01.azurecr.io
          username: projectimage01
          password: $ACR_PASSWORD

      - name: Create Kubernetes Docker Registry Secret
        run: |
          kubectl create secret docker-registry regcred \
            --docker-server=projectimage01.azurecr.io \
            --docker-username=projectimage01\
            --docker-password=$ACR_PASSWORD \
            --docker-email=ankit.agrawal@netsmartz.net \
            --namespace=notes-app

      - name: Deploy Application to AKS
        run: |
          kubectl apply -f django.notes.yaml
          kubectl get node -n notes-app
          kubectl get pods -n notes-app
          kubectl get svc -n notes-app
